version: 0.2
phases:
  pre_build:
    commands:
      - echo "prebuild phase"
      - aws --version

  build:
    commands:
      - echo "running s3 sync command"
      - aws s3 sync ./ s3://${CLONE_TEMPLATE_BUCKET}/ --exclude "buildspec.yml"

      # Convert list parameters to comma-separated strings
      - echo "Converting parameters to string"
      - |
        PUBLIC_SUBNETS="subnet-0bc9e2992de3412ae,subnet-0a2ee0382e3fffdea,subnet-07d88f457c3d22490,subnet-02f6f269c97e21a69,subnet-0b09996022939ca89,subnet-09913ab8e8aa50d3f"
        echo "PublicSubnets as string: $PUBLIC_SUBNETS"

      # Check and deploy/update test-alb if changes are detected
      - echo "checking changes for test-alb"
      - |
        if aws cloudformation describe-stacks --stack-name test-alb >/dev/null 2>&1; then
          echo "Updating test-alb...."
          aws cloudformation create-change-set --stack-name test-alb --template-url https://test--template.s3.amazonaws.com/test-alb.yml --change-set-name test-alb-changeset --capabilities CAPABILITY_NAMED_IAM --parameters ParameterKey=SSLCertificateID,ParameterValue=${SSLCertificateID} ParameterKey=VPC,ParameterValue=${VPC} ParameterKey=PublicSubnets,ParameterValue=${PUBLIC_SUBNETS} ParameterKey=LoadbalancerSecurityGroup,ParameterValue=${LoadbalancerSecurityGroup}
          aws cloudformation wait change-set-create-complete --stack-name test-alb --change-set-name test-alb-changeset
          aws cloudformation describe-change-set --stack-name test-alb --change-set-name test-alb-changeset
        else
          echo "Stack test-alb does not exist. No changes applied."
        fi

artifacts:
  files:
    - "**/*"
